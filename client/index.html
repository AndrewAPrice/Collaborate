<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title></title>
        <script type="text/javascript" src="/client/jquery-1.11.0.min.js"></script>
        <script type="text/javascript" src="/client/tinymce/tinymce.min.js"></script>
        <script type="text/javascript" src="/client/jqwidgets/jqwidgets/jqx-all.js"></script>
        <script type="text/javascript" src="/client/jquery.cookie.js"></script>
        <script type="text/javascript" src="/client/jquery.ba-hashchange.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>

        <link rel="stylesheet" href="/client/jqwidgets/jqwidgets/styles/jqx.base.css" type="text/css" />
        <link rel="stylesheet" type="text/css" href="/client/style.css" />
    </head>
    <body>
        <div id="titlebar">
            <a href="#" class="highlightButton" id="CommunityName">&nbsp;</a>

            <div id="titlebar-left">
                [Search] <a href="#" class="highlightButton">(Search)</a>
                <a href="#" class="highlightButton">(Info)</a>
                <a href="#" class="highlightButton">(Share)</a>
                <a href="#" class="highlightButton">(Print)</a>
            </div>

            <div id="titlebar-right">
                <a href="#" class="highlightButton">(Message?)</a>
                <a href="#" class="highlightButton"><span id="loginName">Log in</span></a>
                <script type="text/javascript">
                    $(function () {
                        $("#loginName").click(function () {
                            if(!loggedIn)
                                showLoginWindow();
                            else
                                toggleUserDropDown();

                            return false;
                        });
                    });
                </script>
            </div>

            <script type="text/javascript">
                var resizeTitleBar = function () {
                    // resize left/right title floats to be the same size, to centre the header text

                    // get their real sizes
                    $("#titlebar-left").width('auto');
                    $("#titlebar-right").width('auto');

                    // resize to the largest
                    var newWidth = Math.max($("#titlebar-left").width(), $("#titlebar-right").width());
                    $("#titlebar-left").width(newWidth);
                    $("#titlebar-right").width(newWidth);
                };
            </script>
        </div>

        <div id="menubar">
            <a href="#blogs" class="highlightButton">Blogs</a>&nbsp;
            <a href="#courses" class="highlightButton">Courses</a>&nbsp;
            <a href="#discussions" class="highlightButton">Discussions</a>&nbsp;
            <a href="#events" class="highlightButton">Events</a>&nbsp;
            <a href="#uploads" class="highlightButton">Uploads</a>&nbsp;
            <a href="#wiki" class="highlightButton">Wiki</a>
        </div>
        
        <!--<div class="editable"">
                     <p>This is an editable div container.</p>
                     <p>Follow us on <a href="http://twitter.com/alohaeditor">Twitter</a>.</p>
                     <ul>
                            <li>list item one</li>
                            <li>list item two</li>
                     </ul>
        </div> -->

        <!-- windows -->
        <!-- login window -->
        <div id="wndLogin">
            <div >Log in</div>
            <div class="centre">
                <div id="loginContent">
                    <span id="loginMessage"></span>
                    <table class="centre">
                        <tr><td>Username:</td><td><input type="text" id="tbLoginUsername" /></td></tr>
                        <tr><td>Password:</td><td><input type="password" id="tbLoginPassword" /></td></tr>
                    </table>
                    <br />
                        <input type="button" value="Log in" id="btnLoginLogin" />
                        <input type="button" value="Cancel" id="btnLoginCancel" />
                        <input type="button" value="Create an account" id="btnLoginCreateAnAccount" />
                        <input type="button" value="Forgot Password" id="btnForgotPassword" />
                </div>

                <div class="loading" id="loginLoading"></div>
            </div>
        </div>
        <script type="text/javascript">
            $(function () {
                $("#wndLogin").jqxWindow({ width: '395px', height: '160px', autoOpen: false });

                $("#tbLoginUsername").jqxInput().width("100%");
                $("#tbLoginPassword").jqxInput().width("100%");
                $("#btnLoginLogin").jqxButton();
                $("#btnLoginLogin").click(function () {
                    username = $("#tbLoginUsername").val();
                    var password = $("#tbLoginPassword").val();

                    $("#loginLoading").show();
                    $("#loginContent").hide();

                    // save username and password in a cookie so when the user reloads they don't have to log in again
                    $.cookie('username', username);
                    $.cookie('password', password);

                    socket.emit('login', { username: username, password: password });

                });
                $("#btnLoginCancel").jqxButton();
                $("#btnLoginCancel").click(function () {
                    $("#wndLogin").jqxWindow("hide");
                });
                $("#btnLoginCreateAnAccount").jqxButton();
                $("#btnLoginCreateAnAccount").click(function () {
                    $("#wndLogin").jqxWindow("hide");
                    showCreateUserWindow();
                });

                $("#btnForgotPassword").jqxButton();
                $("#btnForgotPassword").click(function () {
                    username = $("#tbLoginUsername").val().trim();
                    if (username.length == 0) {
                        $("#loginMessage").addClass("error");
                        $("#loginMessage").text("Please enter a valid username.");
                        return;
                    }


                    // show verify email window
                    $("#wndLogin").jqxWindow("hide");
                    socket.emit('resendVerificationEmail', { username: username });

                    showVerifyEmailWindow();

                    $("#btnVerifyEmailResend").jqxButton({ disabled: true });
                });
            });

            var showLoginWindow = function() {
                $("#wndLogin").jqxWindow("show");
                $("#tbLoginUsername").val("");
                $("#tbLoginPassword").val("");

                $("#loginMessage").text("Please log in.");
                $("#loginMessage").removeClass("error");

                // get global user settings
                if (globalUserSettings == null) {
                    $("#loginLoading").show();
                    $("#loginContent").hide();
                    socket.emit('getGlobalUserSettings', null);
                } else {
                    $("#loginLoading").hide();
                    $("#loginContent").show();
                }
            };

            var loginResponse = function (data) {
                // set login message
                if (data.status == "nouser") {
                    $("#loginMessage").addClass("error");
                    $("#loginMessage").text("There is no user by that username.");
                } else if (data.status == "badpassword") {
                    $("#loginMessage").addClass("error");
                    $("#loginMessage").text("The password you provided is incorrect.");
                }

                if (data.status === "verifyemail") {
                    // show verify email window
                    $("#wndLogin").jqxWindow("hide");

                    showVerifyEmailWindow();
                    clearCookies();
                } else if (data.status === "success") {
                    // we are logged in
                    $("#wndLogin").jqxWindow("hide");

                    loggedIn = true;
                    userid = data.userid;
                    realname = data.realname;
                    forumAdmin = data.forumAdmin;
                    forumModerator = data.forumModerator;

                    $("#loginName").text(realname);

                    if (globalSettings.publicAccess == false)
                        $(window).hashchange();
                } else {
                    $("#loginLoading").hide();
                    $("#loginContent").show();
                    clearCookies();
                }
            };
        </script>

        <!-- create an account window -->
        <div id="wndCreateUser">
            <div >Create an account</div>
            <div class="centre">
                <div id="createUserContent">
                    <span id="createUserMessage"></span>
                    <table class="centre">
                        <tr><td>Username:</td><td><input type="text" id="tbCreateUserUsername" /></td></tr>
                        <tr><td>Real Name:</td><td><input type="text" id="tbCreateUserRealname" /></td></tr>
                        <tr><td>Email Address:</td><td><input type="text" id="tbCreateUserEmail" /></td></tr>
                    </table>
                    <br />
                        <input type="button" value="Register" id="btnCreateUserRegister" />
                        <input type="button" value="Cancel" id="btnCreateUserCancel" />
                </div>

                <div class="loading" id="createUserLoading"></div>
            </div>
        </div>
        <script type="text/javascript">
            
            $(function () {
                $("#wndCreateUser").jqxWindow({ width: '350px', height: '185px', autoOpen: false });

                $("#tbCreateUserUsername").jqxInput().width("100%");
                $("#tbCreateUserRealname").jqxInput().width("100%");
                $("#tbCreateUserEmail").jqxInput().width("100%");
                $("#btnCreateUserRegister").jqxButton();
                $("#btnCreateUserRegister").click(function () {
                    var username = $("#tbCreateUserUsername").val().trim();
                    var realname = $("#tbCreateUserRealname").val().trim();
                    var email = $("#tbCreateUserEmail").val().trim();

                    // test passwords
                    if (username.length == 0) {
                        $("#createUserMessage").addClass("error");
                        $("#createUserMessage").text("Your username cannot be blank.");
                        return;
                    } else if (realname.length == 0) {
                        $("#createUserMessage").addClass("error");
                        $("#createUserMessage").text("Your realname cannot be blank.");
                        return;
                    } else if (email.length == 0 || email.indexOf("@") == -1) {
                        $("#createUserMessage").addClass("error");
                        $("#createUserMessage").text("Your email address must be valid.");
                        return;
                    }

                    $("#createUserLoading").show();
                    $("#createUserContent").hide();

                    socket.emit('createUser', { username: username, realname: realname, email: email });

                });
                $("#btnCreateUserCancel").jqxButton();
                $("#btnCreateUserCancel").click(function () {
                    $("#wndCreateUser").jqxWindow("hide");
                });
            });

            var showCreateUserWindow = function() {
                $("#wndCreateUser").jqxWindow("show");
                $("#tbCreateUserUsername").val("");
                $("#tbCreateUserPassword").val("");
                $("#tbCreateUserConfirmPassword").val("");
                $("#tbCreateUserEmail").val("");

                $("#createUserMessage").text("Enter your details to create a user account.");
                $("#createUserMessage").removeClass("error");

                $("#createUserLoading").hide();
                $("#createUserContent").show();
            };

            var createUserResponse = function (data) {
                // set login message
                if (data.status == "userexists") {
                    $("#createUserMessage").addClass("error");
                    $("#createUserMessage").text("That username is already taken.");
                } else if (data.status == "badusername") {
                    $("#createUserMessage").addClass("error");
                    $("#createUserMessage").text("That username cannot be used.");
                } else if (data.status == "badrealname") {
                    $("#createUserMessage").addClass("error");
                    $("#createUserMessage").text("Your real name is invalid.");
                } else if (data.status == "bademail") {
                    $("#createUserMessage").addClass("error");
                    $("#createUserMessage").text("Please provide a valid email address.");
                }

                if (data.status === "verifyemail") {
                    // show verify email window
                    $("#wndCreateUser").jqxWindow("hide");
                    showVerifyEmailWindow();
                } else {
                    $("#createUserLoading").hide();
                    $("#createUserContent").show();
                }
            };
        </script>

        <!-- verify email address window -->
        <div id="wndVerifyEmail">
            <div >Verify your email address</div>
            <div class="centre">
                <div id="verifyEmailContent">
                    <span id="verifyEmailMessage"></span>
                    <table class="centre">
                        <tr><td>Code:</td><td><input type="text" id="tbVerifyEmailCode" /></td></tr>
                    </table>
                    <br />
                        <input type="button" value="Verify" id="btnVerifyEmailVerify" />
                        <input type="button" value="Cancel" id="btnVerifyEmailCancel" />
                        <input type="button" value="Resend" id="btnVerifyEmailResend" />
                </div>

                <div class="loading" id="verifyEmailLoading"></div>
            </div>
        </div>
        
        <script type="text/javascript">
            $(function () {
                $("#wndVerifyEmail").jqxWindow({ width: '360px', height: '120px', autoOpen: false });

                $("#tbVerifyEmailCode").jqxInput().width("100%");
                $("#btnVerifyEmailVerify").jqxButton();
                $("#btnVerifyEmailVerify").click(function () {
                    var code = $("#tbVerifyEmailCode").val();

                    $("#verifyEmailLoading").show();
                    $("#verifyEmailContent").hide();

                    socket.emit('verifyEmail', { username: username, token: code});

                });
                $("#btnVerifyEmailCancel").jqxButton();
                $("#btnVerifyEmailCancel").click(function () {
                    $("#wndVerifyEmail").jqxWindow("hide");
                });
                $("#btnVerifyEmailResend").jqxButton();
                $("#btnVerifyEmailResend").click(function () {
                    $("#btnVerifyEmailResend").jqxButton({ disabled: true });


                    socket.emit('resendVerificationEmail', { username: username });

                    $("#verifyEmailMessage").text("Another email has been sent to your email address.");
                    $("#verifyEmailMessage").removeClass("error");
                });
            });

            var showVerifyEmailWindow = function () {
                $("#wndVerifyEmail").jqxWindow("show");
                $("#tbVerifyEmailCode").val("");

                $("#verifyEmailMessage").text("Please enter the code that was emailed to you.");
                $("#verifyEmailMessage").removeClass("error");

                $("#verifyEmailLoading").hide();
                $("#verifyEmailContent").show();
                $("#btnVerifyEmailResend").jqxButton({ disabled: false });
            };

            var verifyEmailResponse = function (data) {
                // set login message
                if (data.status === "badcode") {
                    $("#verifyEmailMessage").addClass("error");
                    $("#verifyEmailMessage").text("The code you provided is not correct.");
                }

                if (data.status === "success") {
                    // we are logged in
                    $("#wndVerifyEmail").jqxWindow("hide");
                    showLoginWindow();
                    $("#loginMessage").text("You have verified your email address. Your temporary password is: " + data.password);
                } else {
                    $("#verifyEmailLoading").hide();
                    $("#verifyEmailContent").show();
                }
            };
        </script>

        <!-- user drop down -->
        <div id="userDropDown">
            <a href="#" id="btnUserDropDownSettings" >Settings</a><br />
            <a href="#" id="btnUserDropDownMessages" >Messages</a><br />
            <a href="#" id="btnUserDropDownLogOut" >Log out</a>
        </div>
        <script type="text/javascript">
            $(function () {
                $("#userDropDown").hide();
                $("#btnUserDropDownLogOut").click(function () {
                    hideUserDropDown();
                    logout();
                    return false;
                });
            });

            var showingUserDropDown = false;

            var toggleUserDropDown = function() {
                if(showingUserDropDown) {
                    $("#userDropDown").hide();
                    showingUserDropDown = false;
                } else {
                    $("#userDropDown").show();
                    showingUserDropDown = true;
                }
            };

            var hideUserDropDown = function() {
                $("#userDropDown").hide();
                showingUserDropDown = false;
            };
        </script>

        <!-- main body, home page -->
        <div id="divHomePage" style="display:none;">
            <table width="100%"><tr><td width="30%" valign="top">
                <!-- left column -->

                <div class="panel non-public-panel">
                    <div class="panel-header">Recent Discussion Threads</div>
                    <div class="panel-body">
                        <div class="loading-fixed" id="homePageRecentThreadsLoading"></div>
                        <div id="homePageRecentThreads"></div>
                    </div>
                </div>
                <div class="panel non-public-panel">
                    <div class="panel-header">Recent Blog Posts</div>
                    <div class="panel-body"></div>
                </div>
            </td><td width="40%" valign="top">
                <!-- middle column -->
                
                <!-- welcome message -->
                <div class="panel">
                    <div class="panel-header">Welcome</div>
                    <div class="panel-body" id="WelcomeMessage">
                    </div>
                </div>
                <div class="panel non-public-panel">
                    <div class="panel-header">Recent Activity</div>
                    <div class="panel-body"></div>
                </div>
            </td><td width="30%" valign="top">
                <!-- right column -->
                <div class="panel non-public-panel">
                    <div class="panel-header">Recent Wiki Activity</div>
                    <div class="panel-body"></div>
                </div>
                <div class="panel non-public-panel">
                    <div class="panel-header">Upcoming Events</div>
                    <div class="panel-body"></div>
                </div>
            </td></tr></table>
        </div>

        <script type="text/javascript">
            var showHomePage = function () {
                if (userid != null || globalSettings.publicAccess)
                    $(".non-public-panel").show();
                else
                    $(".non-public-panel").hide();
                
                $("#homePageRecentThreads").hide();
                $("#homePageRecentThreadsLoading").show();
                $("#divHomePage").show();
                socket.emit("loadHomePage", null);
            };

            var loadHomePageResponse = function(data) {
                $("#homePageRecentThreadsLoading").hide();
                var html = generateRecentThreadsHTML(data.threads);
                $("#homePageRecentThreads").html(html);
                $("#homePageRecentThreads").show();
            };
        </script>

        <!-- discussions page-->
        <div id="divDiscussionsPage" style="display:none;">
            <table width="100%"><tr><td width="30%" valign="top">
                <!-- left column -->
                <div class="panel">
                    <div class="panel-header">Recent Discussion Threads</div>
                    <div class="panel-body">
                        <div class="loading-fixed" id="discussionsPageThreadsLoading"></div>
                        <div id="discussionsPageThreads"></div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-header">Recent Discussion Posts</div>
                    <div class="panel-body">
                        <div class="loading-fixed" id="discussionPagePostsLoading"></div>
                        <div id="discussionPagePosts"></div>
                    </div>
                </div>
            </td><td width="70%" valign="top">
                <!-- middle/right column -->
                <div class="panel">
                    <div class="panel-header">Discussion Forums</div>
                    <div class="panel-body">
                        <div class="loading-fixed" id="discussionPageForumsLoading"></div>
                        <div id="discussionPageForums"></div>
                         <input type="button" value="Create A New Forum" id="btnDiscussionsPageNewForum" />
                    </div>
                </div>
            </td></tr></table>
        </div>

        <script type="text/javascript">
            $(function () {
                $("#btnDiscussionsPageNewForum").jqxButton();
                $("#btnDiscussionsPageNewForum").click(function () {
                    showDiscussionsNewForumWindow();
                });
            });
            var showDiscussionsPage = function (dontEmit) {
                $("#discussionsPageThreadsLoading").show();
                $("#discussionPagePostsLoading").show();
                $("#discussionPageForumsLoading").show();

                $("#discussionsPageThreads").hide();
                $("#discussionPagePosts").hide();
                $("#discussionPageForums").hide();

                $("#btnDiscussionsPageNewForum").hide();

                $("#divDiscussionsPage").show();

                if(dontEmit !== true)
                    socket.emit("loadDiscussions", null);
            };

            var generateRecentThreadsHTML = function(threads) {
                var html = "<ul>";
                for (var i = 0 ; i < threads.length; i++) {
                    html += "<li><small><a href='#threads/" + threads[i].thread_id + "'>" + threads[i].thread_title + "</a> ";
                    html += "in <a href='#forums/" + threads[i].forum_id + "'>" + threads[i].forum_title + "</a>";
                    html += "<br />Latest post by <a href='#members/" + threads[i].last_post_by + "'>" + threads[i].last_post_by_username + "</a> ";
                    html += "on " + threads[i].last_post + "</small></li>";
                }
                html += "</ul>";
                return html;
            };

            var loadDiscussionsResponse = function (data) {
                var html;

                if (data.threads !== undefined) {
                    $("#discussionsPageThreadsLoading").hide();
                    html = generateRecentThreadsHTML(data.threads);
                    $("#discussionsPageThreads").html(html);
                    $("#discussionsPageThreads").show();
                }

                if (data.posts !== undefined) {
                    $("#discussionPagePostsLoading").hide();
                    html = "<ul>";
                    for (var i = 0 ; i < data.posts.length; i++) {
                        html += "<li><small><a href='#threads/" + data.posts[i].thread_id + "/" + data.posts[i].post_id + "'>" + data.posts[i].thread_title + "</a> ";
                        html += "in <a href='#forums/" + data.posts[i].forum_id + "'>" + data.posts[i].forum_title + "</a><br /><i>";
                        html += data.posts[i].preview;
                        html += "</i><br />Posted by <a href='#members/" + data.posts[i].post_by + "'>" + data.posts[i].post_by_username + "</a> ";
                        html += "on " + data.posts[i].posted + "</small></li>";
                    }
                    html += "</ul>";
                    $("#discussionPagePosts").html(html);
                    $("#discussionPagePosts").show();
                }

                if (data.forums !== undefined) {
                    $("#discussionPageForumsLoading").hide();
                    html = "<table class='alternating-table' width='100%'>";
                    for (var i = 0; i < data.forums.length; i++) {
                        html += "<tr><td>";
                        html += "<a href='#forums/" + data.forums[i].forum_id + "'>" + data.forums[i].forum_title + "</a><br />";
                        html += "</td><td><small>";
                        if (data.forums[i].latest_post_title !== null) {
                            html += "Latest post in <a href='#threads/" + data.forums[i].latest_thread_id + "'>";
                            html += data.forums[i].latest_post_title + "</a> by ";
                            html += "<a href='#members/" + data.forums[i].latest_post_uid + "'>" + data.forums[i].latest_post_realname + "</a> ";
                            html += "on " + data.forums[i].latest_post;

                            // $("#btnDiscussionsPageNewForum").jqxButton();
                        } else
                            html += "No posts.";

                        html += "</small></td>";
                        if (forumAdmin)
                            html += "<td><input type='button' value='Edit' id='btnDiscussionsPageEdit" + i + "' /></td>";

                        html += "</tr>";
                    }
                    html += "</table>";

                    $("#discussionPageForums").html(html);
                    $("#discussionPageForums").show();
                }
                
                if (forumAdmin) {
                    $("#btnDiscussionsPageNewForum").show();
                    for (var i = 0; i < data.forums.length; i++) {
                        
                        (function(j) {
                            var name = "#btnDiscussionsPageEdit" + j;
                            $(name).jqxButton();
                            $(name).click(function () {
                                showDiscussionsEditForumWindow(data.forums[j].forum_title, data.forums[j].forum_id);
                            });
                        })(i);
                    }
                }


            };
        </script>

         <!-- discussions - new forum window -->
        <div id="wndDiscussionsNewForum">
            <div >New Forum</div>
            <div class="centre">
                <div id="divDiscussionsNewForumBody">
                    <span id="spnDiscussionsNewForumStatus"></span>
                    <table class="centre">
                        <tr><td>Forum Name:</td><td><input type="text" id="tbDiscussionsNewForumName" /></td></tr>
                    </table>
                    <br />
                        <input type="button" value="Create" id="btnDiscussionsNewForumCreate" />
                        <input type="button" value="Cancel" id="btnDiscussionsNewForumCancel" />
                </div>
                <div class="loading" id="discussionsNewForumLoading"></div>
            </div>
        </div>
        
        <script type="text/javascript">
            $(function () {
                $("#wndDiscussionsNewForum").jqxWindow({ width: '360px', height: '120px', autoOpen: false });

                $("#tbDiscussionsNewForumName").jqxInput().width("100%");
                $("#btnDiscussionsNewForumCreate").jqxButton();
                $("#btnDiscussionsNewForumCreate").click(function () {

                    var title = $("#tbDiscussionsNewForumName").val().trim();
                    if (title.length == 0) {
                        $("#spnDiscussionsNewForumStatus").text("The forum name is not valid.");
                        $("#spnDiscussionsNewForumStatus").addClass("error");
                        return;
                    }

                    // show loading bar
                    $("#divDiscussionsNewForumBody").hide();
                    $("#discussionsNewForumLoading").show();

                    // send request
                    socket.emit('createDiscussionForum', { title: title });

                });
                $("#btnDiscussionsNewForumCancel").jqxButton();
                $("#btnDiscussionsNewForumCancel").click(function () {
                    $("#wndDiscussionsNewForum").jqxWindow("hide");
                });
            });

            var showDiscussionsNewForumWindow = function () {
                $("#tbDiscussionsNewForumName").val("");
                $("#spnDiscussionsNewForumStatus").text("Please enter the name of the new forum to create.");
                $("#spnDiscussionsNewForumStatus").removeClass("error");

                $("#divDiscussionsNewForumBody").show();
                $("#discussionsNewForumLoading").hide();
                $("#wndDiscussionsNewForum").jqxWindow("show");
            };

            var createDiscussionForumResponse = function (data) {
                if (data.status !== "success") {
                    $("#spnDiscussionsNewForumStatus").addClass("error");

                    if (data.status === "nopermission")
                        $("#spnDiscussionsNewForumStatus").text("You don't have permission to create a forum.");
                    else
                        $("#spnDiscussionsNewForumStatus").text("The forum name is not valid.");


                    $("#discussionsNewForumLoading").hide();
                    $("#divDiscussionsNewForumBody").show();
                } else {
                    $("#wndDiscussionsNewForum").jqxWindow("hide");
                    loadDiscussionsResponse(data);
                }
            };
        </script>

        <!-- discussions - new forum window -->
        <div id="wndDiscussionsEditForum">
            <div >Edit Forum</div>
            <div class="centre">
                <div id="divDiscussionsEditForumBody">
                    <span id="spnDiscussionsEditForumStatus"></span>
                    <table class="centre">
                        <tr><td>Forum Name:</td><td><input type="text" id="tbDiscussionEditForumName" /></td></tr>
                    </table>
                    <br />
                        <input type="button" value="Rename" id="btnDiscussionsEditForumRename" />
                        <input type="button" value="Cancel" id="btnDiscussionsEditForumCancel" />
                        <input type="button" value="Delete" id="btnDiscussionsEditForumDelete" />
                </div>
                <div class="loading" id="discussionsEditForumLoading"></div>
            </div>
        </div>
        
        <script type="text/javascript">
            var discussionsEditForumOrigTitle = null;
            var discussionsEditForumID = null;

            $(function () {

                $("#wndDiscussionsEditForum").jqxWindow({ width: '360px', height: '120px', autoOpen: false });

                $("#tbDiscussionEditForumName").jqxInput().width("100%");
                $("#btnDiscussionsEditForumRename").jqxButton();
                $("#btnDiscussionsEditForumRename").click(function () {
                    console.log(discussionsEditForumID);
                    if (discussionsEditForumID === null)
                        return;

                    var title = $("#tbDiscussionEditForumName").val().trim();
                    if (title.length == 0) {
                        $("#spnDiscussionsEditForumStatus").text("The forum name is not valid.");
                        $("#spnDiscussionsEditForumStatus").addClass("error");
                        return;
                    }

                    if (title === discussionsEditForumOrigTitle) {
                        $("#spnDiscussionsEditForumStatus").text("The new name is the same as the old name.");
                        $("#spnDiscussionsEditForumStatus").addClass("error");
                        return;
                    }

                    // show loading bar
                    $("#divDiscussionsEditForumBody").hide();
                    $("#discussionsEditForumLoading").show();

                    // send request
                    socket.emit('setDiscussionForumTitle', { id: discussionsEditForumID, title: title });
                });
                $("#btnDiscussionsEditForumCancel").jqxButton();
                $("#btnDiscussionsEditForumCancel").click(function () {
                    $("#wndDiscussionsEditForum").jqxWindow("hide");
                });
                $("#btnDiscussionsEditForumDelete").jqxButton();
                $("#btnDiscussionsEditForumDelete").click(function () {
                    $("#wndDiscussionsEditForum").jqxWindow("hide");

                    showDiscussionsDeleteForumWindow(discussionsEditForumOrigTitle, discussionsEditForumID);
                });
            });

            var showDiscussionsEditForumWindow = function (title, id) {
                discussionsEditForumOrigTitle = title;
                discussionsEditForumID = id;

                $("#tbDiscussionEditForumName").val(title);
                $("#spnDiscussionsEditForumStatus").text("You are editing '" + title + "'.");
                $("#spnDiscussionsEditForumStatus").removeClass("error");

                $("#divDiscussionsEditForumBody").show();
                $("#discussionsEditForumLoading").hide();
                $("#wndDiscussionsEditForum").jqxWindow("show");
            };

            var setDiscussionForumTitleResponse = function(data) {
                if(data.status !== "success") {
                    $("#spnDiscussionsEditForumStatus").addClass("error");

                    if (data.status === "nopermission")
                        $("#spnDiscussionsEditForumStatus").text("You don't have permission to edit this forum.");
                    else
                        $("#spnDiscussionsEditForumStatus").text("The forum name is not valid.");

                    $("#discussionsEditForumLoading").hide();
                    $("#divDiscussionsEditForumBody").show();
                } else {
                    $("#wndDiscussionsEditForum").jqxWindow("hide");
                    loadDiscussionsResponse(data);
                }
            };
        </script>

        <!-- discussions - delete forum window -->
        <div id="wndDiscussionsDeleteForum">
            <div >Edit Forum</div>
            <div class="centre">
                <div id="divDiscussionsDeleteForumBody">
                    <span id="spnDiscussionsDeleteForumStatus"></span>
                    <br /><br />
                        <input type="button" value="Delete Forum" id="btnDiscussionsDeleteForumDelete" />
                        <input type="button" value="Cancel" id="btnDiscussionsDeleteForumCancel" />
                </div>
                <div class="loading" id="discussionsDeleteForumLoading"></div>
            </div>
        </div>
        
        <script type="text/javascript">
            var discussionsDeleteForumID = null;

            $(function () {

                $("#wndDiscussionsDeleteForum").jqxWindow({ width: '360px', height: '130px', autoOpen: false });

                $("#btnDiscussionsDeleteForumDelete").jqxButton();
                $("#btnDiscussionsDeleteForumDelete").click(function () {
                    // show loading bar
                    $("#divDiscussionsDeleteForumBody").hide();
                    $("#discussionsDeleteForumLoading").show();

                    // send request
                    socket.emit('deleteDiscussionForum', { id: discussionsEditForumID });
                });
                $("#btnDiscussionsDeleteForumCancel").jqxButton();
                $("#btnDiscussionsDeleteForumCancel").click(function () {
                    $("#wndDiscussionsDeleteForum").jqxWindow("hide");
                });
            });

            var showDiscussionsDeleteForumWindow = function (title, id) {
                discussionsDeleteForumID = id;

                $("#spnDiscussionsDeleteForumStatus").text("Do you wish to delete the forum '" + title + "' and all associated posts and threads?");
                $("#spnDiscussionsDeleteForumStatus").removeClass("error");

                $("#btnDiscussionsDeleteForumDelete").show();
                $("#divDiscussionsDeleteForumBody").show();
                $("#discussionsDeleteForumLoading").hide();
                $("#wndDiscussionsDeleteForum").jqxWindow("show");
            };

            var deleteDiscussionForumTitleResponse = function (data) {
                if (data.status !== "success") {
                    $("#spnDiscussionsDeleteForumStatus").addClass("error");

                    $("#spnDiscussionsDeleteForumStatus").text("You don't have permission to delete this forum.");
                    $("#btnDiscussionsDeleteForumDelete").hide();

                    $("#discussionsDeleteForumLoading").hide();
                    $("#divDiscussionsDeleteForumBody").show();
                } else {
                    $("#wndDiscussionsDeleteForum").jqxWindow("hide");
                    loadDiscussionsResponse(data);
                }
            };
        </script>

        <!-- forums page -->
        <div id="divForumsPage" style="display:none;">
            <table width="100%"><tr><td width="30%" valign="top">
                <!-- left column -->
                <div class="panel">
                    <div class="panel-header">Forum</div>
                    <div class="panel-body">
                        <div class="loading-fixed" id="Div2"></div>
                        <div id="Div3"></div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-header">Recent Forum Posts</div>
                    <div class="panel-body">
                        <div class="loading-fixed" id="Div4"></div>
                        <div id="Div5"></div>
                    </div>
                </div>
            </td><td width="70%" valign="top">
                <!-- middle/right column -->
                <div class="panel">
                    <div class="panel-header">Threads</div>
                    <div class="panel-body">
                        <div class="loading-fixed" id="Div6"></div>
                        <div id="Div7"></div>
                    </div>
                </div>
            </td></tr></table>
        </div>
        <script type="text/javascript">
            var showForumsPage = function (id) {
                $("#divForumsPage").show();

                socket.emit("loadForum", null);
            };
            
            var loadForumResponse = function (data) {
                $("#discussionsPageThreadsLoading").hide();
                
                $("#discussionsPageThreads").show();

                
            };
        </script>

        <!-- global -->
        <script type="text/javascript">
            var socket = null; // socket object
            var globalSettings = {}; // global site settings
            var globalUserSettings = {}; // global user settings

            var loggedIn = false; // is the user logged in?
            var userid = null; // id of the logged in user
            var username = ""; // username, used when registering, verifying email, etc
            var realname = ""; // realname of the logged in user
            var forumAdmin = false;
            var forumModerator = false;
            var userinfo = null;
            
            var resize = function () {
                var windowHeight = window.innerHeight;
                var windowWidth = window.innerWidth; 
                // resize TinyMCE to take up the window
                var newHeight = windowHeight - 145;
                $(".mce-edit-area").height(newHeight);
                $("#mce_0_ifr").height(newHeight);

                $("#userDropDown").css("left", windowWidth - $("#userDropDown").width());
            };

            var logout = function() {
                socket.emit("logout", null);
                loggedIn = false;
                username = "";
                userid = null;
                $("#loginName").text("Log in");
                // forget that we were logged in, so we don't log back in when the user reloads the page
                clearCookies();

                forumAdmin = false;
                forumModerator = false;

                if (globalSettings.publicAccess == false)
                    $(window).hashchange();
            };

            var clearCookies = function () {
                $.removeCookie('username');
                $.removeCookie('password');
            };

            $(function () {
                resizeTitleBar();
                /*
                tinymce.init({
                    selector: ".editable",
                    width: "100%-10px",
                    plugins: [
                        "advlist autolink lists link image charmap print preview hr anchor pagebreak",
                        "searchreplace wordcount visualblocks visualchars code fullscreen",
                        "insertdatetime media nonbreaking save table contextmenu directionality",
                        "emoticons template paste textcolor"
                    ],
                    toolbar: "insertfile undo redo | styleselect | bold italic | forecolor backcolor emoticons | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image media",
                    setup: function (ed) {999999
                        ed.on('load', resize);
                    }
                });*/
                
                resize();
                $(window).resize(resize);

                // socket stuff
                socket = io.connect();
                    
                socket.on('globalSettings', function (data) {
                    globalSettings = data;
                    $("#CommunityName").text(globalSettings.communityName);
                    $("#WelcomeMessage").text(globalSettings.welcomeMessage);

                    // see if we have our username and password stored in a cookie
                    var usrn = $.cookie('username');
                    var paswd = $.cookie('password');

                    if (usrn !== undefined && paswd !== undefined) {
                        socket.emit('login', { username: usrn, password: paswd });
                    } else
                        $(window).hashchange();
                });

                socket.on('globalUserSettings', function (data) {
                    globalUserSettings = data;

                    // show login window content
                    $("#loginLoading").hide();
                    $("#loginContent").show();

                    if (globalUserSettings.canRegister) {
                        $("#btnLoginCreateAnAccount").show();
                    } else {
                        $("#btnLoginCreateAnAccount").hide();
                    }
                });

                socket.on('loginResponse', loginResponse);
                socket.on('createUserResponse', createUserResponse);
                socket.on('verifyEmailResponse', verifyEmailResponse);

                socket.on('loadHomePageResponse', loadHomePageResponse);

                socket.on('loadDiscussionsResponse', loadDiscussionsResponse);
                socket.on('createDiscussionForumResponse', createDiscussionForumResponse);
                socket.on('setDiscussionForumTitleResponse', setDiscussionForumTitleResponse);
                socket.on('deleteDiscussionForumResponse', deleteDiscussionForumTitleResponse);

                socket.on('loadForumResponse', loadForumResponse);

                $(window).hashchange(hashchange);
            });

            var page = "";

            var loadPage = function (page, noredirect) {
            };


            // hide all existing pages so we can later only show the one we want
            var hideExistingPages = function () {
                $("#divHomePage").hide();
                $("#divDiscussionsPage").hide();
                $("#wndDiscussionsNewForum").jqxWindow("hide");
                $("#divForumsPage").hide();
            };

            var hashchange = function () {
                if (location.hash === '#')
                    alert("Hash is '#' - forgot to handle!");

                var hash = location.hash;

                if (userid == null && !globalSettings.publicAccess)
                    hash = ''; // homepage if there's no public access
                
                var leftSection = hash;
                var rightSection = "";
                var splitter = hash.indexOf('/');
                if (splitter >= 0) {
                    rightSection = leftSection.substr(splitter + 1);
                    leftSection = leftSection.substr(0, splitter);
                }

                // hide all existing tabs
                hideExistingPages();
                
                switch (leftSection) {
                    case "": showHomePage(); break;
                    case "#blogs": break;
                    case "#courses": break;
                    case "#discussions": showDiscussionsPage(); break;
                    case "#forums": showForumsPage(rightSection); break;
                    case "#threads": break;
                    case "#events": break;
                    case "#members": break;
                    case "#uploads": break;
                    case "#wiki": break;
                    default: break;
                }
            };
        </script>
    </body>
</html>