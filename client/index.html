<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title></title>
        <script type="text/javascript" src="/client/jquery-1.11.0.min.js"></script>
        <script type="text/javascript" src="/client/tinymce/tinymce.min.js"></script>
        <script type="text/javascript" src="/client/jqwidgets/jqwidgets/jqx-all.js"></script>
        <script src="/socket.io/socket.io.js"></script>

        <link rel="stylesheet" href="/client/jqwidgets/jqwidgets/styles/jqx.base.css" type="text/css" />
        <link rel="stylesheet" type="text/css" href="/client/style.css" />
    </head>
    <body>
        <div id="titlebar">
            <span id="WikiName">&nbsp;</span>

            <div id="titlebar-left">
                [Search] <a href="#" class="highlightButton">(Search)</a>
                <a href="#" class="highlightButton">(Info)</a>
                <a href="#" class="highlightButton">(Share)</a>
                <a href="#" class="highlightButton">(Print)</a>

            </div>

            <div id="titlebar-right">
                <a href="#" class="highlightButton">(Message?)</a>
                <a href="#" class="highlightButton"><span id="loginName">Log in</span></a>
                <script type="text/javascript">
                    $(function () {
                        $("#loginName").click(function () {
                            if(!loggedIn)
                                showLoginWindow();
                            else
                                toggleUserDropDown();
                        });
                    });
                </script>
            </div>

            <script type="text/javascript">
                var resizeTitleBar = function () {
                    // resize left/right title floats to be the same size, to centre the header text

                    // get their real sizes
                    $("#titlebar-left").width('auto');
                    $("#titlebar-right").width('auto');

                    // resize to the largest
                    var newWidth = Math.max($("#titlebar-left").width(), $("#titlebar-right").width());
                    $("#titlebar-left").width(newWidth);
                    $("#titlebar-right").width(newWidth);
                };
            </script>
        </div>
        <div class="editable"">
                     <p>This is an editable div container.</p>
                     <p>Follow us on <a href="http://twitter.com/alohaeditor">Twitter</a>.</p>
                     <ul>
                            <li>list item one</li>
                            <li>list item two</li>
                     </ul>
        </div>

        <!-- windows -->
        <!-- login window -->
        <div id="wndLogin">
            <div >Log in</div>
            <div class="centre">
                <div id="loginContent">
                    <span id="loginMessage"></span>
                    <table class="centre">
                        <tr><td>Username:</td><td><input type="text" id="tbLoginUsername" /></td></tr>
                        <tr><td>Password:</td><td><input type="password" id="tbLoginPassword" /></td></tr>
                    </table>
                    <br />
                        <input type="button" value="Log in" id="btnLoginLogin" />
                        <input type="button" value="Cancel" id="btnLoginCancel" />
                        <input type="button" value="Create an account" id="btnLoginCreateAnAccount" />
                </div>

                <div class="loading" id="loginLoading"></div>
            </div>
        </div>
        <script type="text/javascript">
            $(function () {
                $("#wndLogin").jqxWindow({ width: '300px', height: '140px', autoOpen: false });

                $("#tbLoginUsername").jqxInput().width("100%");
                $("#tbLoginPassword").jqxInput().width("100%");
                $("#btnLoginLogin").jqxButton();
                $("#btnLoginLogin").click(function () {
                    username = $("#tbLoginUsername").val();
                    var password = $("#tbLoginPassword").val();

                    $("#loginLoading").show();
                    $("#loginContent").hide();

                    socket.emit('login', { username: username, password: password });

                });
                $("#btnLoginCancel").jqxButton();
                $("#btnLoginCancel").click(function () {
                    $("#wndLogin").jqxWindow("hide");
                });
                $("#btnLoginCreateAnAccount").jqxButton();
                $("#btnLoginCreateAnAccount").click(function () {
                    $("#wndLogin").jqxWindow("hide");
                    showCreateUserWindow();
                });
            });

            var showLoginWindow = function() {
                $("#wndLogin").jqxWindow("show");
                $("#tbLoginUsername").val("");
                $("#tbLoginPassword").val("");

                $("#loginMessage").text("Please log in.");
                $("#loginMessage").removeClass("error");

                // get global user settings
                if (globalUserSettings == null) {
                    $("#loginLoading").show();
                    $("#loginContent").hide();
                    socket.emit('getGlobalUserSettings', null);
                } else {
                    $("#loginLoading").hide();
                    $("#loginContent").show();
                }
            };

            var loginResponse = function (data) {
                // set login message
                if (data.status == "nouser") {
                    $("#loginMessage").addClass("error");
                    $("#loginMessage").text("There is no user by that username.");
                } else if (data.status == "badpassword") {
                    $("#loginMessage").addClass("error");
                    $("#loginMessage").text("The password you provided is incorrect.");
                }

                if (data.status === "verifyemail") {
                    // show verify email window
                    $("#wndLogin").jqxWindow("hide");

                    showVerifyEmailWindow();
                } else if (data.status === "success") {
                    // we are logged in
                    $("#wndLogin").jqxWindow("hide");

                    loggedIn = true;
                    username = data.username;

                    $("#loginName").text(username);

                    // reloadPage();
                } else {
                    $("#loginLoading").hide();
                    $("#loginContent").show();
                }
            };
        </script>

        <!-- create an account window -->
        <div id="wndCreateUser">
            <div >Create an account</div>
            <div class="centre">
                <div id="createUserContent">
                    <span id="createUserMessage"></span>
                    <table class="centre">
                        <tr><td>Username:</td><td><input type="text" id="tbCreateUserUsername" /></td></tr>
                        <tr><td>Password:</td><td><input type="password" id="tbCreateUserPassword" /></td></tr>
                        <tr><td>Confirm Password:</td><td><input type="password" id="tbCreateUserConfirmPassword" /></td></tr>
                        <tr><td>Email Address:</td><td><input type="text" id="tbCreateUserEmail" /></td></tr>
                    </table>
                    <br />
                        <input type="button" value="Register" id="btnCreateUserRegister" />
                        <input type="button" value="Cancel" id="btnCreateUserCancel" />
                </div>

                <div class="loading" id="createUserLoading"></div>
            </div>
        </div>
        <script type="text/javascript">
            $(function () {
                $("#wndCreateUser").jqxWindow({ width: '350px', height: '185px', autoOpen: false });

                $("#tbCreateUserUsername").jqxInput().width("100%");
                $("#tbCreateUserPassword").jqxInput().width("100%");
                $("#tbCreateUserConfirmPassword").jqxInput().width("100%");
                $("#tbCreateUserEmail").jqxInput().width("100%");
                $("#btnCreateUserRegister").jqxButton();
                $("#btnCreateUserRegister").click(function () {
                    username = $("#tbCreateUserUsername").val();
                    var password = $("#tbCreateUserPassword").val();
                    var email = $("#tbCreateUserEmail").val();

                    // test passwords
                    if (password !== $("#tbCreateUserConfirmPassword").val()) {
                        $("#createUserMessage").addClass("error");
                        $("#createUserMessage").text("Your passwords do not match.");
                        return;
                    }

                    $("#createUserLoading").show();
                    $("#createUserContent").hide();

                    socket.emit('createUser', { username: username, password: password, email: email });

                });
                $("#btnCreateUserCancel").jqxButton();
                $("#btnCreateUserCancel").click(function () {
                    $("#wndCreateUser").jqxWindow("hide");
                });
            });

            var showCreateUserWindow = function() {
                $("#wndCreateUser").jqxWindow("show");
                $("#tbCreateUserUsername").val("");
                $("#tbCreateUserPassword").val("");
                $("#tbCreateUserConfirmPassword").val("");
                $("#tbCreateUserEmail").val("");

                $("#createUserMessage").text("Enter your details to create a user account.");
                $("#createUserMessage").removeClass("error");

                $("#createUserLoading").hide();
                $("#createUserContent").show();
            };

            var createUserResponse = function (data) {
                // set login message
                if (data.status == "userexists") {
                    $("#createUserMessage").addClass("error");
                    $("#createUserMessage").text("That username is already taken.");
                } else if (data.status == "badusername") {
                    $("#createUserMessage").addClass("error");
                    $("#createUserMessage").text("That username cannot be used.");
                } else if (data.status == "badpassword") {
                    $("#createUserMessage").addClass("error");
                    $("#createUserMessage").text(globalUserSettings.passwordRequirements);
                } else if (data.status == "bademail") {
                    $("#createUserMessage").addClass("error");
                    $("#createUserMessage").text("Please provide a valid email address.");
                }

                if (data.status === "verifyemail") {
                    // show verify email window
                    $("#wndCreateUser").jqxWindow("hide");
                    showVerifyEmailWindow();
                } else if (data.status === "success") {
                    $("#wndCreateUser").jqxWindow("hide");
                    // ask user to log in
                    showLoginWindow();
                    $("#loginMessage").text("You have succesfully registered.");
                } else {
                    $("#createUserLoading").hide();
                    $("#createUserContent").show();
                }
            };
        </script>

        <!-- verify email address window -->
        <div id="wndVerifyEmail">
            <div >Verify your email address</div>
            <div class="centre">
                <div id="verifyEmailContent">
                    <span id="verifyEmailMessage"></span>
                    <table class="centre">
                        <tr><td>Code:</td><td><input type="text" id="tbVerifyEmailCode" /></td></tr>
                    </table>
                    <br />
                        <input type="button" value="Verify" id="btnVerifyEmailVerify" />
                        <input type="button" value="Cancel" id="btnVerifyEmailCancel" />
                        <input type="button" value="Resend" id="btnVerifyEmailResend" />
                </div>

                <div class="loading" id="verifyEmailLoading"></div>
            </div>
        </div>
        
        <script type="text/javascript">
            $(function () {
                $("#wndVerifyEmail").jqxWindow({ width: '360px', height: '120px', autoOpen: false });

                $("#tbVerifyEmailCode").jqxInput().width("100%");
                $("#btnVerifyEmailVerify").click(function () {
                    var code = $("#tbVerifyEmailCode").val();

                    $("#verifyEmailLoading").show();
                    $("#verifyEmailContent").hide();

                    socket.emit('verifyEmail', { username: username, token: code});

                });
                $("#btnVerifyEmailCancel").jqxButton();
                $("#btnVerifyEmailCancel").click(function () {
                    $("#wndVerifyEmail").jqxWindow("hide");
                });
                $("#btnVerifyEmailResend").jqxButton();
                $("#btnVerifyEmailResend").click(function () {
                    $("#btnVerifyEmailResend").jqxButton({ disabled: true });


                    socket.emit('resendVerificationEmail', { username: username });

                    $("#verifyEmailMessage").text("Another email has been sent to your email address.");
                    $("#verifyEmailMessage").removeClass("error");
                });

            });

            var showVerifyEmailWindow = function () {
                $("#wndVerifyEmail").jqxWindow("show");
                $("#tbVerifyEmailCode").val("");

                $("#verifyEmailMessage").text("Please enter the code that was emailed to you.");
                $("#verifyEmailMessage").removeClass("error");

                $("#verifyEmailLoading").hide();
                $("#verifyEmailContent").show();
                $("#btnVerifyEmailResend").jqxButton({ disabled: false });
            };

            var verifyEmailResponse = function (data) {
                // set login message
                if (data.status === "badcode") {
                    $("#verifyEmailMessage").addClass("error");
                    $("#verifyEmailMessage").text("The code you provided is not correct.");
                }

                if (data.status === "success") {
                    // we are logged in
                    $("#wndVerifyEmail").jqxWindow("hide");
                    showLoginWindow();
                    $("#loginMessage").text("You have verified your email address.");
                } else {
                    $("#verifyEmailLoading").hide();
                    $("#verifyEmailContent").show();
                }
            };
        </script>

        <!-- user drop down -->
        <div id="userDropDown">
            <a href="#" id="btnUserDropDownSettings" >Settings</a><br />
            <a href="#" id="btnUserDropDownMessages" >Messages</a><br />
            <a href="#" id="btnUserDropDownLogOut" >Log out</a>
        </div>
        <script type="text/javascript">
            $(function () {
                $("#userDropDown").hide();
                $("#btnUserDropDownLogOut").click(function () {
                    hideUserDropDown();
                    logout();
                });
            });

            var showingUserDropDown = false;

            var toggleUserDropDown = function() {
                if(showingUserDropDown) {
                    $("#userDropDown").hide();
                    showingUserDropDown = false;
                } else {
                    $("#userDropDown").show();
                    showingUserDropDown = true;
                }
            };

            var hideUserDropDown = function() {
                $("#userDropDown").hide();
                showingUserDropDown = false;
            };
        </script>

        <!-- global -->
        <script type="text/javascript">
            var socket = null; // socket object
            var globalSettings = null; // global wiki settings
            var globalUserSettings = null; // global user settings

            var loggedIn = false; // is the user logged in?
            var username = ""; // name of the logged in user


            var resize = function () {
                var windowHeight = window.innerHeight;
                var windowWidth = window.innerWidth; 
                // resize TinyMCE to take up the window
                var newHeight = windowHeight - 145;
                $(".mce-edit-area").height(newHeight);
                $("#mce_0_ifr").height(newHeight);

                $("#userDropDown").css("left", windowWidth - $("#userDropDown").width());
            };

            var reloadPage = function () {
                console.log("load page");
            };

            var logout = function() {
                socket.emit("logout", null);
                loggedIn = false;
                username = "";
                $("#loginName").text("Log in");
            };

            $(function () {
                resizeTitleBar();
                /*
                tinymce.init({
                    selector: ".editable",
                    width: "100%-10px",
                    plugins: [
                        "advlist autolink lists link image charmap print preview hr anchor pagebreak",
                        "searchreplace wordcount visualblocks visualchars code fullscreen",
                        "insertdatetime media nonbreaking save table contextmenu directionality",
                        "emoticons template paste textcolor"
                    ],
                    toolbar: "insertfile undo redo | styleselect | bold italic | forecolor backcolor emoticons | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image media",
                    setup: function (ed) {999999
                        ed.on('load', resize);
                    }
                });*/
                
                resize();
                $(window).resize(resize);

                // socket stuff
                socket = io.connect();
                    
                socket.on('globalSettings', function (data) {
                    globalSettings = data;
                    $("#WikiName").text(globalSettings.wikiName);
                });

                socket.on('globalUserSettings', function (data) {
                    globalUserSettings = data;

                    // show login window content
                    $("#loginLoading").hide();
                    $("#loginContent").show();

                    if (globalUserSettings.canRegister) {
                        $("#btnLoginCreateAnAccount").show();
                    } else {
                        $("#btnLoginCreateAnAccount").hide();
                    }
                });

                socket.on('loginResponse', loginResponse);
                socket.on('createUserResponse', createUserResponse);
                socket.on('verifyEmailResponse', verifyEmailResponse);
            });
        </script>
    </body>
</html>